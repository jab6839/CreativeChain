{% extends "base.html" %}
{% block content %}

<div class="container" style="max-width:1100px;margin:auto;">
  <h2>Reminders</h2>

  <!-- Add Reminder -->
  <form method="POST" action="{{ url_for('reminders') }}" class="note-form" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:20px;">
    <input name="title" class="input-box same-width" style="width:260px" placeholder="Title (e.g., Call patient…)" required>
    <input name="assignee" class="input-box same-width" style="width:180px" placeholder="Assignee (e.g., MA Team)">
    <select name="kind" class="input-box same-width" style="width:150px">
      <option>Patient</option>
      <option>Internal</option>
    </select>
    <select name="priority" class="input-box same-width" style="width:130px">
      <option>High</option>
      <option selected>Medium</option>
      <option>Low</option>
    </select>
    <input type="datetime-local" name="due" class="input-box same-width" style="width:220px" required>
    <button type="submit">Add</button>
  </form>

  <!-- Buckets -->
  <div style="display:flex;flex-wrap:wrap;gap:20px;justify-content:center;margin-top:25px;">
    {% set now = namespace(ts=namespace()) %}
    {% set today_list = [] %}
    {% set upcoming_list = [] %}
    {% set overdue_list = [] %}

    {% for r in reminders %}
      {% set dt = r.due %}
      {% set _ = [] %}
    {% endfor %}

    {% macro badge(text, cls) -%}
      <span class="{{ cls }}" style="padding:2px 8px;border-radius:999px;font-size:12px;line-height:20px;color:#fff;margin-left:6px;">{{ text }}</span>
    {%- endmacro %}

    {% set grouped = {'Overdue':[], 'Today':[], 'Upcoming':[]} %}
    {% for r in reminders %}
      {% set due = r.due %}
      {% set date_only = due.split(' ')[0] %}
      {% set status = r.status %}
      {% set bucket = 'Upcoming' %}
      {# naive bucketing by date string compared to today's date #}
      {% set today = (caller or none) %}
      {% set current = (cycler or none) %}
      {% set today_str = (namespace() or none) %}
      {% set today_str = caller %}
      {% set today_str = lipsum %}
    {% endfor %}
  </div>

  <!-- Simpler: do bucketing in one pass with inline JS (no build tools) -->
  <div id="reminders-root"></div>
</div>

<script>
  // Minimal client bucketing to avoid template gymnastics
  const data = {{ reminders|tojson }};
  const root = document.getElementById('reminders-root');

  function fmtDate(s) {
    // Expect "YYYY-MM-DD HH:MM"
    return s.replace('T',' ');
  }

  function bucketize(items) {
    const today = new Date();
    const ymd = (d)=> [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');

    const todayStr = ymd(today);
    const buckets = { Overdue:[], Today:[], Upcoming:[] };

    for (const r of items) {
      const dueStr = (r.due || '').replace('T',' ');
      const dateOnly = dueStr.slice(0,10);
      if (r.status === 'done') { continue; }
      if (dateOnly < todayStr) buckets.Overdue.push(r);
      else if (dateOnly === todayStr) buckets.Today.push(r);
      else buckets.Upcoming.push(r);
    }
    return buckets;
  }

  function pill(priority) {
    const map = { High:'bg-red', Medium:'bg-orange', Low:'bg-green' };
    const cls = map[priority] || 'bg-gray';
    return `<span class="pill ${cls}">${priority}</span>`;
  }

  function row(r) {
    return `
      <div class="card" style="min-width:280px;max-width:360px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>${r.title}</strong>
          ${pill(r.priority)}
        </div>
        <div style="margin-top:6px;font-size:14px;">Due: ${fmtDate(r.due)}</div>
        <div style="margin-top:6px;font-size:14px;">Kind: ${r.kind} • Assignee: ${r.assignee}</div>
        <form method="POST" action="/reminders/complete/${r.id}" style="display:inline;">
          <button type="submit" style="margin-top:10px;">Complete</button>
        </form>
        <form method="POST" action="/reminders/snooze/${r.id}" style="display:inline;">
          <button type="submit" style="margin-top:10px;">Snooze +1d</button>
        </form>
        <form method="POST" action="/reminders/delete/${r.id}" style="display:inline;">
          <button type="submit" style="margin-top:10px;background:#dc3545;">Delete</button>
        </form>
      </div>
    `;
  }

  function section(title, items) {
    if (!items.length) return '';
    return `
      <div style="width:100%;margin-top:25px;">
        <h3 style="margin:10px 0;">${title}</h3>
        <div style="display:flex;flex-wrap:wrap;gap:16px;">${items.map(row).join('')}</div>
      </div>
    `;
  }

  const buckets = bucketize(data);
  root.innerHTML = section('Today', buckets.Today)
                 + section('Upcoming', buckets.Upcoming)
                 + section('Overdue', buckets.Overdue);
</script>

<style>
  .pill{padding:2px 8px;border-radius:999px;color:#fff;font-size:12px}
  .bg-red{background:#dc3545}
  .bg-orange{background:#fd7e14}
  .bg-green{background:#28a745}
  .bg-gray{background:#6c757d}
</style>

{% endblock %}

